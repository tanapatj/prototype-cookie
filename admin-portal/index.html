<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConsentManager - Admin Portal</title>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* â”€â”€ Login Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 25px 60px rgba(0,0,0,0.2);
            text-align: center;
        }

        .login-logo {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .login-card h1 {
            font-size: 1.75rem;
            color: #1a1a2e;
            margin-bottom: 0.5rem;
        }

        .login-card p {
            color: #6b7280;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .google-signin-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .login-restriction {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .login-error {
            background: #fee2e2;
            color: #991b1b;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            margin-top: 1rem;
            display: none;
        }

        /* â”€â”€ Setup Banner (shown if CLIENT_ID not configured) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #setup-banner {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            color: #92400e;
            text-align: left;
            display: none;
        }

        #setup-banner strong { display: block; margin-bottom: 0.25rem; }
        #setup-banner a { color: #d97706; font-weight: 600; }

        /* â”€â”€ Admin Portal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #admin-portal {
            display: none;
            padding: 2rem;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-left h1 { font-size: 2rem; }
        .header-left p { opacity: 0.9; font-size: 0.95rem; }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255,255,255,0.15);
            border-radius: 40px;
            padding: 0.5rem 1rem 0.5rem 0.5rem;
            backdrop-filter: blur(10px);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .user-avatar-placeholder {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .user-info { color: white; line-height: 1.2; }
        .user-name { font-weight: 600; font-size: 0.9rem; }
        .user-email { font-size: 0.75rem; opacity: 0.85; }

        .btn-signout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-signout:hover { background: rgba(255,255,255,0.35); }

        /* â”€â”€ Cards & Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            color: white;
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.25);
        }

        .stat-value { font-size: 2.5rem; font-weight: bold; margin: 0.5rem 0; }
        .stat-label { opacity: 0.85; font-size: 0.875rem; }
        .stat-loading { font-size: 1.5rem !important; opacity: 0.5; }

        .card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f3f4f6;
        }

        /* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 2rem;
            background: #f9fafb;
            border-radius: 10px;
            padding: 0.25rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            color: #6b7280;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* â”€â”€ Forms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 640px) { .form-grid { grid-template-columns: 1fr; } }

        .form-group { margin-bottom: 1.25rem; }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        label .required { color: #ef4444; margin-left: 2px; }

        input, textarea, select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .help-text { font-size: 0.8rem; color: #9ca3af; margin-top: 0.3rem; }

        .btn {
            padding: 0.75rem 1.75rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }

        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn-secondary:hover:not(:disabled) { background: #e5e7eb; }

        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover:not(:disabled) { background: #dc2626; }

        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.8rem; }

        /* â”€â”€ Alerts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .alert-error   { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .alert-info    { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }

        /* â”€â”€ API Key display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .api-key-result {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .api-key-result h3 { color: #065f46; margin-bottom: 1rem; }

        .key-value {
            background: white;
            border: 2px dashed #34d399;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            word-break: break-all;
            color: #065f46;
            font-weight: 600;
            letter-spacing: 0.03em;
        }

        .copy-row {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        .integration-box {
            background: #1e1e2e;
            color: #cdd6f4;
            border-radius: 10px;
            padding: 1.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.82rem;
            line-height: 1.6;
            overflow-x: auto;
            margin-top: 0.75rem;
            white-space: pre;
        }

        /* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .table-wrapper { overflow-x: auto; }

        table { width: 100%; border-collapse: collapse; }

        th, td { padding: 0.85rem 1rem; text-align: left; border-bottom: 1px solid #f3f4f6; }

        th { background: #f9fafb; font-weight: 600; color: #374151; font-size: 0.875rem; }

        tr:hover td { background: #f9fafb; }

        .badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .badge-active   { background: #d1fae5; color: #065f46; }
        .badge-inactive { background: #fee2e2; color: #991b1b; }
        .badge-warning  { background: #fef3c7; color: #92400e; }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #9ca3af;
        }

        .empty-state .empty-icon { font-size: 3rem; margin-bottom: 1rem; }

        /* â”€â”€ Loading spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .spinner {
            width: 20px; height: 20px;
            border: 2px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-row td { text-align: center; color: #6b7280; padding: 2rem; }

        /* â”€â”€ Quota bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .quota-bar {
            background: #e5e7eb;
            border-radius: 4px;
            height: 6px;
            width: 100px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
        }

        .quota-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .quota-fill.low    { background: #10b981; }
        .quota-fill.medium { background: #f59e0b; }
        .quota-fill.high   { background: #ef4444; }
    </style>
</head>
<body>

    <!-- â”€â”€ Login Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="login-screen">
        <div class="login-card">
            <div class="login-logo">ğŸ”</div>
            <h1>Admin Portal</h1>
            <p>ConsentManager API Key Management<br>Sign in with your Conicle account to continue.</p>

            <div id="setup-banner">
                <strong>âš™ï¸ One-time setup required</strong>
                Replace <code>YOUR_GOOGLE_CLIENT_ID</code> in this file with your OAuth Client ID.<br>
                <a href="https://console.cloud.google.com/apis/credentials?project=conicle-ai-dev" target="_blank">
                    â†’ Get it from Google Cloud Console
                </a>
            </div>

            <div class="google-signin-wrapper">
                <div id="g_id_onload"
                     data-client_id="YOUR_GOOGLE_CLIENT_ID"
                     data-context="signin"
                     data-ux_mode="popup"
                     data-callback="handleCredentialResponse"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin"
                     data-type="standard"
                     data-shape="rectangular"
                     data-theme="filled_blue"
                     data-text="signin_with"
                     data-size="large"
                     data-logo_alignment="left"
                     data-width="320">
                </div>
            </div>

            <div class="login-restriction">
                ğŸ¢ &nbsp;Only <strong>@conicle.com</strong> accounts are allowed
            </div>

            <div class="login-error" id="login-error"></div>
        </div>
    </div>

    <!-- â”€â”€ Admin Portal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="admin-portal">
        <div class="container">

            <header>
                <div class="header-left">
                    <h1>ğŸ” ConsentManager Admin</h1>
                    <p>API Key Management Portal</p>
                </div>
                <div style="display:flex; align-items:center; gap:1rem; flex-wrap:wrap;">
                    <div class="user-badge">
                        <div id="user-avatar-wrapper">
                            <div class="user-avatar-placeholder">ğŸ‘¤</div>
                        </div>
                        <div class="user-info">
                            <div class="user-name" id="user-name">Admin</div>
                            <div class="user-email" id="user-email"></div>
                        </div>
                    </div>
                    <button class="btn-signout" onclick="signOut()">Sign out</button>
                </div>
            </header>

            <!-- Stats -->
            <div class="grid">
                <div class="stat-card">
                    <div class="stat-label">Total API Keys</div>
                    <div class="stat-value stat-loading" id="stat-total">â€”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Keys</div>
                    <div class="stat-value stat-loading" id="stat-active">â€”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Events (This Month)</div>
                    <div class="stat-value stat-loading" id="stat-events">â€”</div>
                </div>
            </div>

            <div class="card">
                <div class="tabs">
                    <div class="tab active" data-tab="generate" onclick="switchTab(this)">ğŸ”‘ Generate Key</div>
                    <div class="tab" data-tab="manage"   onclick="switchTab(this)">ğŸ“‹ Manage Keys</div>
                    <div class="tab" data-tab="usage"    onclick="switchTab(this)">ğŸ“Š Usage Stats</div>
                </div>

                <!-- â”€â”€ Tab 1: Generate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                <div id="tab-generate" class="tab-content active">
                    <h2>ğŸ”‘ Generate New API Key</h2>

                    <div id="alert-generate"></div>

                    <form id="generate-form" onsubmit="handleGenerate(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="client-name">Client Name <span class="required">*</span></label>
                                <input type="text" id="client-name" required placeholder="e.g., Acme Corp" maxlength="200">
                                <div class="help-text">Company or client name</div>
                            </div>

                            <div class="form-group">
                                <label for="client-email">Contact Email</label>
                                <input type="email" id="client-email" placeholder="contact@example.com">
                                <div class="help-text">For client communication</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="domains">Allowed Domains <span class="required">*</span></label>
                            <textarea id="domains" rows="3" required placeholder="example.com&#10;*.example.com&#10;app.example.com"></textarea>
                            <div class="help-text">One domain per line. Use *.example.com for all subdomains.</div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="quota">Monthly Quota (Events)</label>
                                <input type="number" id="quota" placeholder="Leave blank for unlimited" min="1">
                                <div class="help-text">Max events per month</div>
                            </div>

                            <div class="form-group">
                                <label for="expires">Expiration Date</label>
                                <input type="date" id="expires">
                                <div class="help-text">Leave blank = never expires</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="notes">Internal Notes</label>
                            <textarea id="notes" rows="2" placeholder="Any internal notes..." maxlength="500"></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary" id="generate-btn">
                            ğŸ”‘ Generate & Save API Key
                        </button>
                    </form>

                    <div id="key-result" style="display:none;"></div>
                </div>

                <!-- â”€â”€ Tab 2: Manage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                <div id="tab-manage" class="tab-content">
                    <h2>ğŸ“‹ Manage API Keys</h2>

                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; flex-wrap:wrap; gap:0.5rem;">
                        <span id="keys-count" style="color:#6b7280; font-size:0.875rem;"></span>
                        <button class="btn btn-secondary btn-small" onclick="loadKeys()">
                            ğŸ”„ Refresh
                        </button>
                    </div>

                    <div id="alert-manage"></div>

                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>API Key</th>
                                    <th>Domains</th>
                                    <th>Status</th>
                                    <th>Usage / Quota</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="keys-tbody">
                                <tr class="loading-row">
                                    <td colspan="7"><div class="spinner"></div> Loading keys...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- â”€â”€ Tab 3: Usage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
                <div id="tab-usage" class="tab-content">
                    <h2>ğŸ“Š Usage Statistics</h2>
                    <div class="alert alert-info">
                        <strong>ğŸ“Š Live Analytics in BigQuery</strong><br>
                        For full analytics dashboards, open BigQuery and run the queries in
                        <code>bigquery/example-queries.sql</code>.
                        <br><br>
                        <a href="https://console.cloud.google.com/bigquery?project=conicle-ai-dev"
                           target="_blank" style="font-weight:600; color:#1e40af;">
                            Open BigQuery Console â†’
                        </a>
                    </div>

                    <div style="margin-top:1.5rem;">
                        <h3 style="margin-bottom:1rem; color:#374151;">Quick Query Templates</h3>

                        <details style="margin-bottom:1rem; background:#f9fafb; border-radius:8px; padding:1rem;">
                            <summary style="cursor:pointer; font-weight:600; color:#374151;">Events by Client (This Month)</summary>
                            <pre class="integration-box" style="margin-top:0.75rem;">SELECT
  k.client_name,
  COUNT(e.event_id) AS events_this_month,
  k.monthly_quota,
  k.current_month_usage
FROM `conicle-ai-dev.consent_analytics.api_keys` k
LEFT JOIN `conicle-ai-dev.consent_analytics.consent_events` e
  ON k.api_key = e.api_key
  AND DATE(e.event_timestamp) >= DATE_TRUNC(CURRENT_DATE(), MONTH)
WHERE k.is_active = TRUE
GROUP BY k.client_name, k.monthly_quota, k.current_month_usage
ORDER BY events_this_month DESC;</pre>
                        </details>

                        <details style="margin-bottom:1rem; background:#f9fafb; border-radius:8px; padding:1rem;">
                            <summary style="cursor:pointer; font-weight:600; color:#374151;">Daily Accept / Reject Rate</summary>
                            <pre class="integration-box" style="margin-top:0.75rem;">SELECT
  DATE(event_timestamp) AS date,
  client_name,
  COUNTIF(accept_type = 'all')       AS accepted_all,
  COUNTIF(accept_type = 'necessary') AS rejected_all,
  COUNTIF(accept_type = 'custom')    AS custom,
  COUNT(*) AS total
FROM `conicle-ai-dev.consent_analytics.consent_events`
WHERE DATE(event_timestamp) >= DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY)
GROUP BY date, client_name
ORDER BY date DESC, total DESC;</pre>
                        </details>

                        <details style="background:#f9fafb; border-radius:8px; padding:1rem;">
                            <summary style="cursor:pointer; font-weight:600; color:#374151;">Device / Browser Breakdown</summary>
                            <pre class="integration-box" style="margin-top:0.75rem;">SELECT
  device_type,
  browser_name,
  COUNT(*) AS events
FROM `conicle-ai-dev.consent_analytics.consent_events`
WHERE DATE(event_timestamp) >= DATE_TRUNC(CURRENT_DATE(), MONTH)
GROUP BY device_type, browser_name
ORDER BY events DESC
LIMIT 20;</pre>
                        </details>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- â”€â”€ Confirm Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="confirm-modal" style="
        display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5);
        z-index:1000; align-items:center; justify-content:center;">
        <div style="background:white; border-radius:16px; padding:2rem; max-width:420px; width:90%; box-shadow:0 25px 60px rgba(0,0,0,0.2);">
            <h3 style="margin-bottom:1rem; color:#374151;">âš ï¸ Revoke API Key?</h3>
            <p id="confirm-message" style="color:#6b7280; margin-bottom:1.5rem; font-size:0.95rem;"></p>
            <div style="display:flex; gap:0.75rem; justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="closeConfirm()">Cancel</button>
                <button class="btn btn-danger" id="confirm-action-btn">Revoke Key</button>
            </div>
        </div>
    </div>

    <script>
        // â”€â”€ Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const ADMIN_FUNCTION_URL = 'https://adminkeymanager-pxoxh5sfqa-as.a.run.app';
        const GOOGLE_CLIENT_ID   = 'YOUR_GOOGLE_CLIENT_ID'; // Replace with your OAuth Client ID

        // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let currentToken = null;
        let currentUser  = null;

        // â”€â”€ Setup Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') {
            document.getElementById('setup-banner').style.display = 'block';
        }

        // â”€â”€ Google Sign-In callback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function handleCredentialResponse(response) {
            const idToken = response.credential;

            // Decode JWT payload (middle segment)
            try {
                const payload = JSON.parse(atob(idToken.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
                const email = payload.email || '';

                if (!email.endsWith('@conicle.com')) {
                    showLoginError(`Access denied: ${email} is not a @conicle.com account.`);
                    return;
                }

                // Auth success
                currentToken = idToken;
                currentUser  = payload;
                showPortal();

            } catch (e) {
                showLoginError('Failed to decode sign-in credentials. Please try again.');
            }
        }

        function showLoginError(msg) {
            const el = document.getElementById('login-error');
            el.textContent = msg;
            el.style.display = 'block';
        }

        // â”€â”€ Portal setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showPortal() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-portal').style.display = 'block';

            // Set user info in header
            document.getElementById('user-name').textContent  = currentUser.name || currentUser.email;
            document.getElementById('user-email').textContent = currentUser.email;

            const avatarWrapper = document.getElementById('user-avatar-wrapper');
            if (currentUser.picture) {
                avatarWrapper.innerHTML = `<img src="${currentUser.picture}" class="user-avatar" alt="avatar" referrerpolicy="no-referrer">`;
            }

            // Load stats + key list
            loadStats();
            loadKeys();
        }

        function signOut() {
            currentToken = null;
            currentUser  = null;
            document.getElementById('admin-portal').style.display  = 'none';
            document.getElementById('login-screen').style.display  = 'flex';
            document.getElementById('login-error').style.display   = 'none';
            document.getElementById('keys-tbody').innerHTML = '<tr class="loading-row"><td colspan="7"><div class="spinner"></div> Loading keys...</td></tr>';
        }

        // â”€â”€ Admin API helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function adminRequest(body) {
            if (!currentToken) throw new Error('Not authenticated');

            const res = await fetch(ADMIN_FUNCTION_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentToken}`,
                },
                body: JSON.stringify(body),
            });

            const data = await res.json();
            if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
            return data;
        }

        // â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadStats() {
            try {
                const data = await adminRequest({ action: 'list' });
                const keys = data.keys || [];
                document.getElementById('stat-total').textContent  = keys.length;
                document.getElementById('stat-active').textContent = keys.filter(k => k.is_active).length;
                const totalUsage = keys.reduce((s, k) => s + (k.current_month_usage || 0), 0);
                document.getElementById('stat-events').textContent = totalUsage.toLocaleString();
                document.querySelectorAll('.stat-loading').forEach(el => el.classList.remove('stat-loading'));
            } catch (e) {
                console.warn('Stats failed:', e.message);
            }
        }

        // â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function switchTab(el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.getElementById(`tab-${el.dataset.tab}`).classList.add('active');
            if (el.dataset.tab === 'manage') loadKeys();
        }

        // â”€â”€ Generate API Key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function handleGenerate(event) {
            event.preventDefault();

            const clientName  = document.getElementById('client-name').value.trim();
            const clientEmail = document.getElementById('client-email').value.trim();
            const domainsText = document.getElementById('domains').value;
            const quota       = document.getElementById('quota').value;
            const expiresAt   = document.getElementById('expires').value;
            const notes       = document.getElementById('notes').value.trim();

            const domains = domainsText.split('\n').map(d => d.trim()).filter(Boolean);
            if (domains.length === 0) {
                showAlert('alert-generate', 'Please enter at least one domain.', 'error');
                return;
            }

            const btn = document.getElementById('generate-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Generating...';

            try {
                const data = await adminRequest({
                    action: 'generate',
                    clientName,
                    domains,
                    clientEmail: clientEmail || null,
                    quota: quota || null,
                    expiresAt: expiresAt || null,
                    notes: notes || null,
                });

                showKeyResult(data.apiKey, clientName, domains);
                document.getElementById('generate-form').reset();
                showAlert('alert-generate', `âœ… API key for <strong>${escapeHtml(clientName)}</strong> was generated and saved to BigQuery automatically.`, 'success');

                // Refresh stats
                loadStats();

            } catch (e) {
                showAlert('alert-generate', `âŒ Failed to generate key: ${escapeHtml(e.message)}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ”‘ Generate & Save API Key';
            }
        }

        function showKeyResult(apiKey, clientName, domains) {
            const integrationCode =
`// ConsentManager BigQuery logging for ${clientName}
window.addEventListener('cm:onFirstConsent', async ({ detail }) => {
  await fetch('https://logconsentauth-pxoxh5sfqa-as.a.run.app', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-API-Key': '${apiKey}'  // Keep this server-side in production
    },
    body: JSON.stringify({
      event_type: detail.eventName,
      cookie: detail.cookie,
      acceptType: detail.cookie.acceptType,
      pageUrl: window.location.href,
      version: '1.0.0'
    })
  });
});`;

            const container = document.getElementById('key-result');
            container.style.display = 'block';
            container.innerHTML = `
                <div class="api-key-result">
                    <h3>âœ… API Key Ready</h3>
                    <p style="color:#065f46; margin-bottom:0.75rem; font-size:0.9rem;">
                        Send this key to your client. It cannot be retrieved again after leaving this page.
                    </p>
                    <label style="color:#374151; font-size:0.85rem; font-weight:600;">API Key:</label>
                    <div class="key-value" id="new-api-key">${escapeHtml(apiKey)}</div>
                    <div class="copy-row">
                        <button class="btn btn-secondary btn-small" onclick="copyText('new-api-key', this)">ğŸ“‹ Copy Key</button>
                    </div>

                    <div style="margin-top:1.25rem;">
                        <label style="color:#374151; font-size:0.85rem; font-weight:600;">Integration Code (for client):</label>
                        <div class="integration-box" id="integration-code">${escapeHtml(integrationCode)}</div>
                        <div class="copy-row">
                            <button class="btn btn-secondary btn-small" onclick="copyText('integration-code', this)">ğŸ“‹ Copy Code</button>
                        </div>
                    </div>
                </div>
            `;
            container.scrollIntoView({ behavior: 'smooth' });
        }

        // â”€â”€ Manage Keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadKeys() {
            const tbody = document.getElementById('keys-tbody');
            tbody.innerHTML = '<tr class="loading-row"><td colspan="7"><div class="spinner"></div> Loading...</td></tr>';

            try {
                const data = await adminRequest({ action: 'list' });
                const keys = data.keys || [];

                document.getElementById('keys-count').textContent =
                    `${keys.length} key${keys.length !== 1 ? 's' : ''} total`;

                if (keys.length === 0) {
                    tbody.innerHTML = `
                        <tr><td colspan="7">
                            <div class="empty-state">
                                <div class="empty-icon">ğŸ”‘</div>
                                <p>No API keys yet. Generate one from the Generate Key tab.</p>
                            </div>
                        </td></tr>`;
                    return;
                }

                tbody.innerHTML = keys.map(k => {
                    const usagePct = k.monthly_quota
                        ? Math.min(100, Math.round((k.current_month_usage / k.monthly_quota) * 100))
                        : null;
                    const fillClass = usagePct === null ? '' : usagePct >= 90 ? 'high' : usagePct >= 70 ? 'medium' : 'low';
                    const domains = Array.isArray(k.allowed_domains) ? k.allowed_domains : [];

                    return `
                        <tr>
                            <td>
                                <strong>${escapeHtml(k.client_name)}</strong>
                                ${k.client_email ? `<br><span style="font-size:0.8rem;color:#6b7280;">${escapeHtml(k.client_email)}</span>` : ''}
                            </td>
                            <td>
                                <code style="font-size:0.8rem;background:#f3f4f6;padding:0.2rem 0.4rem;border-radius:4px;">
                                    ${escapeHtml(k.api_key_masked || 'â€”')}
                                </code>
                            </td>
                            <td style="font-size:0.8rem;">
                                ${domains.slice(0, 3).map(d => `<span style="display:block;">${escapeHtml(d)}</span>`).join('')}
                                ${domains.length > 3 ? `<span style="color:#9ca3af;">+${domains.length - 3} more</span>` : ''}
                            </td>
                            <td>
                                <span class="badge ${k.is_active ? 'badge-active' : 'badge-inactive'}">
                                    ${k.is_active ? 'Active' : 'Revoked'}
                                </span>
                                ${k.expires_date ? `<br><span style="font-size:0.75rem;color:#9ca3af;">Expires ${escapeHtml(k.expires_date)}</span>` : ''}
                            </td>
                            <td>
                                ${usagePct !== null ? `
                                    <div class="quota-bar">
                                        <div class="quota-fill ${fillClass}" style="width:${usagePct}%;"></div>
                                    </div>
                                    <span style="font-size:0.8rem;">${(k.current_month_usage||0).toLocaleString()} / ${(k.monthly_quota||0).toLocaleString()}</span>
                                ` : `<span style="font-size:0.8rem;color:#9ca3af;">${(k.current_month_usage||0).toLocaleString()} / âˆ</span>`}
                            </td>
                            <td style="font-size:0.8rem; color:#6b7280;">
                                ${escapeHtml(k.created_date || 'â€”')}<br>
                                <span style="font-size:0.75rem;">by ${escapeHtml(k.created_by || 'â€”')}</span>
                            </td>
                            <td>
                                ${k.is_active ? `
                                    <button class="btn btn-danger btn-small"
                                        onclick="confirmRevoke('${escapeHtml(k.api_key_masked)}', '${escapeHtml(k.client_name)}')">
                                        ğŸš« Revoke
                                    </button>
                                ` : '<span style="color:#9ca3af;font-size:0.8rem;">â€”</span>'}
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (e) {
                tbody.innerHTML = `<tr class="loading-row"><td colspan="7" style="color:#ef4444;">âŒ Failed to load: ${escapeHtml(e.message)}</td></tr>`;
            }
        }

        // â”€â”€ Revoke key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let pendingRevokeKey = null;

        function confirmRevoke(maskedKey, clientName) {
            pendingRevokeKey = maskedKey;
            document.getElementById('confirm-message').innerHTML =
                `This will permanently deactivate the API key for <strong>${escapeHtml(clientName)}</strong>.<br><br>
                 Key: <code style="background:#f3f4f6;padding:2px 6px;border-radius:4px;">${escapeHtml(maskedKey)}</code><br><br>
                 This action cannot be undone.`;
            document.getElementById('confirm-action-btn').onclick = executeRevoke;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeConfirm() {
            document.getElementById('confirm-modal').style.display = 'none';
            pendingRevokeKey = null;
        }

        async function executeRevoke() {
            const maskedKey = pendingRevokeKey;
            closeConfirm();

            try {
                await adminRequest({ action: 'revoke', apiKeyMasked: maskedKey });
                showAlert('alert-manage', `âœ… API key <code>${escapeHtml(maskedKey)}</code> has been revoked.`, 'success');
                loadKeys();
                loadStats();
            } catch (e) {
                showAlert('alert-manage', `âŒ Failed to revoke: ${escapeHtml(e.message)}`, 'error');
            }
        }

        // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 6000);
        }

        function copyText(elementId, btn) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                const original = btn.innerHTML;
                btn.innerHTML = 'âœ… Copied!';
                setTimeout(() => { btn.innerHTML = original; }, 2000);
            });
        }
    </script>
</body>
</html>
