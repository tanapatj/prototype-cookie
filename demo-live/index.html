<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConsentManager - Live Demo | Conicle AI</title>
    
    <!-- Consent Manager CSS -->
    <link rel="stylesheet" href="https://storage.googleapis.com/consent-manager-cdn-tanapatj-jkt/v1.0.0/consent-manager.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        header {
            text-align: center;
            color: white;
            padding: 3rem 0;
        }
        
        h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }
        
        .demo-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .demo-card h2 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }
        
        .demo-card h3 {
            color: #764ba2;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 1.3rem;
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin: 1rem 0;
        }
        
        button {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #764ba2;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #63408a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(118, 75, 162, 0.4);
        }
        
        .btn-outline {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-outline:hover {
            background: #667eea;
            color: white;
        }
        
        .status-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .status-box.success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .status-box.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .info-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        .info-item strong {
            color: #764ba2;
            display: block;
            margin-bottom: 0.3rem;
        }
        
        code {
            background: #f8f9fa;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            color: #d63384;
        }
        
        .event-log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
        }
        
        .event-log div {
            padding: 0.3rem 0;
            border-bottom: 1px solid #333;
        }
        
        .event-log .timestamp {
            color: #858585;
            margin-right: 0.5rem;
        }
        
        .event-log .event-name {
            color: #4ec9b0;
            font-weight: bold;
        }
        
        .event-log .event-data {
            color: #ce9178;
        }
        
        .tracking-demo {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .tracking-demo.blocked {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .tracking-demo.allowed {
            background: #d4edda;
            border-color: #28a745;
        }
        
        footer {
            text-align: center;
            color: white;
            padding: 2rem 0;
            margin-top: 2rem;
        }
        
        footer a {
            color: white;
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
        
        .badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .badge.success {
            background: #28a745;
            color: white;
        }
        
        .badge.danger {
            background: #dc3545;
            color: white;
        }
        
        .badge.warning {
            background: #ffc107;
            color: #333;
        }
        
        /* Style Configurator */
        .config-panel {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .config-group {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .config-group h4 {
            color: #764ba2;
            margin-bottom: 0.8rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .config-item {
            margin-bottom: 1rem;
        }
        
        .config-item:last-child {
            margin-bottom: 0;
        }
        
        .config-item label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.4rem;
        }
        
        .config-item input[type="color"] {
            width: 100%;
            height: 40px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .config-item input[type="range"] {
            width: 100%;
        }
        
        .config-item select {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
        }
        
        .config-item select:focus,
        .config-item input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .range-value {
            display: inline-block;
            min-width: 40px;
            text-align: right;
            font-weight: 600;
            color: #667eea;
            margin-left: 0.5rem;
        }
        
        .config-actions {
            display: flex;
            gap: 0.8rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .btn-config {
            flex: 1;
            min-width: 150px;
            padding: 0.7rem 1.2rem;
            font-size: 0.95rem;
        }
        
        .code-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
            display: none;
        }
        
        .code-output.show {
            display: block;
        }
        
        .copy-success {
            background: #28a745;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üç™ ConsentManager</h1>
            <p class="subtitle">Live Demo - GDPR Compliant Cookie Consent</p>
            <p>Hosted on GCP Cloud Storage (Bangkok üáπüá≠) | Built by Conicle AI</p>
        </header>
        
        <div class="demo-card">
            <h2>üìä Current Consent Status</h2>
            <div id="consent-status" class="status-box">
                Loading...
            </div>
            
            <div class="info-grid">
                <div class="info-item">
                    <strong>Cookie Name:</strong>
                    <span id="cookie-name">-</span>
                </div>
                <div class="info-item">
                    <strong>Consent Valid:</strong>
                    <span id="consent-valid">-</span>
                </div>
                <div class="info-item">
                    <strong>Accept Type:</strong>
                    <span id="accept-type">-</span>
                </div>
                <div class="info-item">
                    <strong>Last Updated:</strong>
                    <span id="last-updated">-</span>
                </div>
            </div>
        </div>
        
        <div class="demo-card">
            <h2>üé® Style Configurator</h2>
            <p>Customize the consent banner appearance in real-time!</p>
            
            <div class="config-panel">
                <div class="config-grid">
                    <!-- Colors -->
                    <div class="config-group">
                        <h4>üé® Colors</h4>
                        <div class="config-item">
                            <label for="primary-color">Primary Color:</label>
                            <input type="color" id="primary-color" value="#667eea" onchange="updateStyle()">
                        </div>
                        <div class="config-item">
                            <label for="bg-color">Background Color:</label>
                            <input type="color" id="bg-color" value="#ffffff" onchange="updateStyle()">
                        </div>
                        <div class="config-item">
                            <label for="text-color">Text Color:</label>
                            <input type="color" id="text-color" value="#2c3e50" onchange="updateStyle()">
                        </div>
                        <div class="config-item">
                            <label for="btn-text-color">Button Text:</label>
                            <input type="color" id="btn-text-color" value="#ffffff" onchange="updateStyle()">
                        </div>
                    </div>
                    
                    <!-- Layout & Position -->
                    <div class="config-group">
                        <h4>üìê Layout & Position</h4>
                        <div class="config-item">
                            <label for="layout">Layout Type:</label>
                            <select id="layout" onchange="updateStyle()">
                                <option value="box">Box (Default)</option>
                                <option value="cloud">Cloud</option>
                                <option value="bar">Bar</option>
                            </select>
                        </div>
                        <div class="config-item">
                            <label for="position">Position:</label>
                            <select id="position" onchange="updateStyle()">
                                <option value="bottom">Bottom</option>
                                <option value="middle">Middle</option>
                                <option value="top">Top</option>
                                <option value="bottom left">Bottom Left</option>
                                <option value="bottom right">Bottom Right</option>
                            </select>
                        </div>
                        <div class="config-item">
                            <label for="transition">Transition:</label>
                            <select id="transition" onchange="updateStyle()">
                                <option value="slide">Slide</option>
                                <option value="zoom">Zoom</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Typography & Spacing -->
                    <div class="config-group">
                        <h4>üìù Typography</h4>
                        <div class="config-item">
                            <label>Font Size: <span class="range-value" id="font-size-value">14px</span></label>
                            <input type="range" id="font-size" min="12" max="20" value="14" onchange="updateStyle()">
                        </div>
                        <div class="config-item">
                            <label>Border Radius: <span class="range-value" id="border-radius-value">12px</span></label>
                            <input type="range" id="border-radius" min="0" max="30" value="12" onchange="updateStyle()">
                        </div>
                        <div class="config-item">
                            <label>Button Radius: <span class="range-value" id="btn-radius-value">8px</span></label>
                            <input type="range" id="btn-radius" min="0" max="30" value="8" onchange="updateStyle()">
                        </div>
                    </div>
                    
                    <!-- Advanced Options -->
                    <div class="config-group">
                        <h4>‚öôÔ∏è Advanced</h4>
                        <div class="config-item">
                            <label for="modal-layout">Preferences Layout:</label>
                            <select id="modal-layout" onchange="updateStyle()">
                                <option value="box">Box</option>
                                <option value="bar">Wide</option>
                            </select>
                        </div>
                        <div class="config-item">
                            <label for="modal-position">Preferences Position:</label>
                            <select id="modal-position" onchange="updateStyle()">
                                <option value="center">Center</option>
                                <option value="left">Left</option>
                                <option value="right">Right</option>
                            </select>
                        </div>
                        <div class="config-item">
                            <label for="flip-buttons">Button Order:</label>
                            <select id="flip-buttons" onchange="updateStyle()">
                                <option value="false">Accept First</option>
                                <option value="true">Reject First</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="config-actions">
                    <button class="btn-primary btn-config" onclick="applyStyle()">
                        ‚ú® Apply Style
                    </button>
                    <button class="btn-secondary btn-config" onclick="showCode()">
                        üìã Show Configuration Code
                    </button>
                    <button class="btn-outline btn-config" onclick="resetStyle()">
                        üîÑ Reset to Default
                    </button>
                </div>
                
                <div id="code-output" class="code-output"></div>
            </div>
        </div>
        
        <div class="demo-card">
            <h2>üéÆ Interactive Controls</h2>
            <p>Test the consent manager functionality:</p>
            
            <h3>Modal Controls</h3>
            <div class="button-group">
                <button class="btn-primary" onclick="showConsentModal()">
                    Show Consent Banner
                </button>
                <button class="btn-secondary" onclick="showPreferencesModal()">
                    Show Preferences
                </button>
                <button class="btn-outline" onclick="hideModals()">
                    Hide Modals
                </button>
            </div>
            
            <h3>Accept/Reject Controls</h3>
            <div class="button-group">
                <button class="btn-primary" onclick="acceptAll()">
                    ‚úì Accept All
                </button>
                <button class="btn-secondary" onclick="acceptAnalyticsOnly()">
                    üìä Accept Analytics Only
                </button>
                <button class="btn-outline" onclick="rejectAll()">
                    ‚úó Reject All (Necessary Only)
                </button>
            </div>
            
            <h3>Testing Controls</h3>
            <div class="button-group">
                <button class="btn-outline" onclick="resetConsent()">
                    üîÑ Reset & Clear Cookie
                </button>
                <button class="btn-outline" onclick="refreshStatus()">
                    üîç Refresh Status
                </button>
            </div>
        </div>
        
        <div class="demo-card">
            <h2>üîí Tracking Script Demo</h2>
            <p>These simulate Google Analytics and Facebook Pixel - they only run if you accept the corresponding category:</p>
            
            <div class="tracking-demo" id="analytics-status">
                <strong>üìä Analytics (Google Analytics)</strong>
                <div id="analytics-result">Waiting for consent...</div>
            </div>
            
            <div class="tracking-demo" id="marketing-status">
                <strong>üì¢ Marketing (Facebook Pixel)</strong>
                <div id="marketing-result">Waiting for consent...</div>
            </div>
            
            <p style="margin-top: 1rem;">
                <strong>How it works:</strong> These scripts have <code>data-category="analytics"</code> and <code>type="text/plain"</code>. 
                ConsentManager automatically converts them to <code>type="text/javascript"</code> when you accept the category.
            </p>
        </div>
        
        <div class="demo-card">
            <h2>üì° Event Log</h2>
            <p>Watch consent events in real-time:</p>
            <div class="event-log" id="event-log">
                <div><span class="timestamp">[Init]</span> <span class="event-name">Event logger started</span></div>
            </div>
            <button class="btn-outline" onclick="clearLog()">Clear Log</button>
        </div>
        
        <div class="demo-card">
            <h2>üìö API Reference</h2>
            <p>Try these commands in the browser console:</p>
            <div class="status-box">
                <div><code>ConsentManager.getUserPreferences()</code> - Get current preferences</div>
                <div><code>ConsentManager.acceptedCategory('analytics')</code> - Check if category accepted</div>
                <div><code>ConsentManager.getCookie()</code> - Get cookie data</div>
                <div><code>ConsentManager.validConsent()</code> - Check if consent is valid</div>
                <div><code>ConsentManager.reset(true)</code> - Reset everything</div>
            </div>
        </div>
        
        <div class="demo-card">
            <h2>üöÄ Integration Info</h2>
            <div class="info-grid">
                <div class="info-item">
                    <strong>CDN JavaScript:</strong>
                    <code style="word-break: break-all;">
                        https://storage.googleapis.com/consent-manager-cdn-tanapatj-jkt/v1.0.0/consent-manager.umd.js
                    </code>
                </div>
                <div class="info-item">
                    <strong>CDN CSS:</strong>
                    <code style="word-break: break-all;">
                        https://storage.googleapis.com/consent-manager-cdn-tanapatj-jkt/v1.0.0/consent-manager.css
                    </code>
                </div>
                <div class="info-item">
                    <strong>Region:</strong>
                    Asia-Southeast3 (Bangkok üáπüá≠)
                </div>
                <div class="info-item">
                    <strong>Version:</strong>
                    1.0.0
                </div>
            </div>
        </div>
        
        <div class="demo-card" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-left: 4px solid #28a745;">
            <h2>üî• BigQuery Logging ACTIVE + üîê AUTHENTICATED</h2>
            <p><strong>This demo logs detailed consent events to BigQuery in real-time with API key authentication!</strong></p>
            <div class="info-grid">
                <div class="info-item" style="background: rgba(255,255,255,0.7);">
                    <strong>Dataset:</strong>
                    conicle-ai-dev.consent_analytics
                </div>
                <div class="info-item" style="background: rgba(255,255,255,0.7);">
                    <strong>Table:</strong>
                    consent_events (37 columns)
                </div>
                <div class="info-item" style="background: rgba(255,255,255,0.7);">
                    <strong>Cloud Function:</strong>
                    logConsentAuth (asia-southeast1)
                </div>
                <div class="info-item" style="background: rgba(255,255,255,0.7);">
                    <strong>Features:</strong>
                    ‚úÖ API Key Auth, ‚úÖ Domain Whitelist, ‚úÖ Raw IP, ‚úÖ UTM, ‚úÖ Thai labels
                </div>
                <div class="info-item" style="background: rgba(255,193,7,0.3); padding: 10px; border-left: 3px solid #ffc107;">
                    <strong>üîê API Key:</strong>
                    Loaded securely via server config
                </div>
            </div>
            <p style="margin-top: 1rem;">
                <strong>üìä What's logged:</strong> IP address, browser, device, UTM parameters, action labels (Thai/English), and more!
            </p>
            <p style="margin-top: 0.5rem;">
                <strong>Try it:</strong> Accept/reject cookies and check BigQuery to see detailed logs! ‚úÖ
            </p>
            <p style="margin-top: 0.5rem; font-size: 0.9rem;">
                üí° <em>Query your data:</em> See <code>bigquery/example-queries.sql</code> in the GitHub repo for analytics queries.
            </p>
        </div>
    </div>
    
    <footer>
        <p>Built with ‚ù§Ô∏è by Conicle AI Data Engineering Team</p>
        <p><a href="https://github.com/tanapatj/prototype-cookie" target="_blank">View on GitHub</a></p>
    </footer>
    
    <!-- Consent Manager JS -->
    <script src="https://storage.googleapis.com/consent-manager-cdn-tanapatj-jkt/v1.0.0/consent-manager.umd.js"></script>
    
    <!-- Demo tracking scripts (blocked until consent) -->
    <script data-category="analytics" type="text/plain">
        // Simulated Google Analytics
        console.log('üéØ Analytics script executed!');
        document.getElementById('analytics-result').innerHTML = '‚úÖ Script is running! (Simulated GA pageview sent)';
        document.getElementById('analytics-status').className = 'tracking-demo allowed';
        logEvent('Analytics Script', 'Executed - Google Analytics would track now');
    </script>
    
    <script data-category="marketing" type="text/plain">
        // Simulated Facebook Pixel
        console.log('üéØ Marketing script executed!');
        document.getElementById('marketing-result').innerHTML = '‚úÖ Script is running! (Simulated FB Pixel loaded)';
        document.getElementById('marketing-status').className = 'tracking-demo allowed';
        logEvent('Marketing Script', 'Executed - Facebook Pixel would track now');
    </script>
    
    <!-- BigQuery Logging Setup -->
    <script>
        // ==========================================
        // BIGQUERY LOGGING - NOW ACTIVE WITH AUTHENTICATION!
        // ==========================================
        // SECURITY: API key must be injected server-side at deploy time.
        // Never hardcode API keys in client-side source code.
        const BIGQUERY_LOG_URL = window.__CM_CONFIG__?.logUrl || '';
        const BIGQUERY_API_KEY = window.__CM_CONFIG__?.apiKey || '';
        
        // Generate anonymous session ID
        function getSessionId() {
            let sessionId = sessionStorage.getItem('consent_session_id');
            if (!sessionId) {
                sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('consent_session_id', sessionId);
            }
            return sessionId;
        }
        
        // Log to BigQuery via Cloud Function
        async function logToBigQuery(eventType, eventData) {
            try {
                const payload = {
                    event_type: eventType,
                    cookie: eventData.cookie,
                    acceptType: eventData.cookie?.categories?.length === 3 ? 'all' : 
                               eventData.cookie?.categories?.length === 1 ? 'necessary' : 'custom',
                    rejectedCategories: [],
                    changedCategories: eventData.changedCategories || [],
                    rejectedServices: eventData.rejectedServices || {},
                    
                    // User info (anonymous)
                    sessionId: getSessionId(),
                    userId: null,  // Anonymous
                    
                    // Page context
                    pageUrl: window.location.href,
                    pageTitle: document.title,
                    referrer: document.referrer,
                    language: navigator.language,
                    
                    // Metadata
                    version: '1.0.0',
                    logIP: true  // NOW ENABLED: Raw IP address will be logged (with hash backup)
                };
                
                const response = await fetch(BIGQUERY_LOG_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-API-Key': BIGQUERY_API_KEY
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Logged to BigQuery:', result.event_id);
                    logEvent('BigQuery', `‚úÖ Event logged: ${eventType} (${result.event_id.substr(0, 8)}...)`);
                } else {
                    console.warn('‚ö†Ô∏è BigQuery log failed:', response.status);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è BigQuery logging error:', error.message);
                // Don't block user experience
            }
        }
        
        console.log('üî• BigQuery logging is ACTIVE!');
        console.log('üìä Session ID:', getSessionId());
    </script>
    
    <!-- Initialize ConsentManager -->
    <script>
        // Store base configuration for reinitialization
        let baseConfig = {
            categories: {
                necessary: {
                    readOnly: true,
                    enabled: true
                },
                analytics: {},
                marketing: {}
            },
            
            language: {
                default: 'en',
                translations: {
                    en: {
                        consentModal: {
                            title: 'üç™ Cookie Consent Demo',
                            description: 'This is a live demo of ConsentManager. We use cookies to demonstrate GDPR-compliant consent management. Try accepting/rejecting different categories and watch how tracking scripts behave!',
                            acceptAllBtn: 'Accept all',
                            acceptNecessaryBtn: 'Reject all',
                            showPreferencesBtn: 'Manage preferences'
                        },
                        preferencesModal: {
                            title: 'Cookie Preferences',
                            acceptAllBtn: 'Accept all',
                            acceptNecessaryBtn: 'Reject all',
                            savePreferencesBtn: 'Save preferences',
                            closeIconLabel: 'Close',
                            sections: [
                                {
                                    title: 'Cookie Usage',
                                    description: 'This demo shows how to block tracking scripts until user consent. Real implementation would include Google Analytics, Facebook Pixel, etc.'
                                },
                                {
                                    title: 'Strictly Necessary Cookies',
                                    description: 'These cookies are essential. They store your consent preferences.',
                                    linkedCategory: 'necessary'
                                },
                                {
                                    title: 'Analytics Cookies',
                                    description: 'Help us understand visitor behavior (simulated Google Analytics in this demo).',
                                    linkedCategory: 'analytics',
                                    cookieTable: {
                                        headers: {
                                            name: 'Cookie',
                                            domain: 'Domain',
                                            expiration: 'Expiration',
                                            description: 'Description'
                                        },
                                        body: [
                                            {
                                                name: '_ga',
                                                domain: 'conicle.ai',
                                                expiration: '2 years',
                                                description: 'Google Analytics tracking cookie'
                                            }
                                        ]
                                    }
                                },
                                {
                                    title: 'Marketing Cookies',
                                    description: 'Used for targeted advertising (simulated Facebook Pixel in this demo).',
                                    linkedCategory: 'marketing',
                                    cookieTable: {
                                        headers: {
                                            name: 'Cookie',
                                            domain: 'Domain',
                                            expiration: 'Expiration',
                                            description: 'Description'
                                        },
                                        body: [
                                            {
                                                name: '_fbp',
                                                domain: 'conicle.ai',
                                                expiration: '90 days',
                                                description: 'Facebook Pixel tracking cookie'
                                            }
                                        ]
                                    }
                                }
                            ]
                        }
                    }
                }
            }
        };
        
        // Initialize ConsentManager with base config
        ConsentManager.run(baseConfig);
        
        // Function to reinitialize ConsentManager with new guiOptions
        function reinitializeConsentManager(guiOptions) {
            // ConsentManager.run() only executes once (checks window._cmRun).
            // We must call reset() first to tear down the old modals and
            // set _cmRun = false, then call run() again with the new config.
            // reset() without arguments preserves the user's consent cookie.
            ConsentManager.reset();
            
            const newConfig = JSON.parse(JSON.stringify(baseConfig));
            newConfig.guiOptions = guiOptions;
            
            ConsentManager.run(newConfig);
            
            console.log('ConsentManager reinitialized with guiOptions:', guiOptions);
        }
        
        // Event listeners (with BigQuery logging)
        window.addEventListener('cm:onConsent', function({detail}) {
            logEvent('cm:onConsent', 'User gave consent: ' + detail.cookie.categories.join(', '));
            refreshStatus();
            checkTrackingScripts();
            
            // Log to BigQuery
            logToBigQuery('consent', detail);
        });
        
        window.addEventListener('cm:onChange', function({detail}) {
            logEvent('cm:onChange', 'User changed preferences: ' + detail.changedCategories.join(', '));
            refreshStatus();
            checkTrackingScripts();
            
            // Log to BigQuery
            logToBigQuery('change', detail);
        });
        
        window.addEventListener('cm:onModalShow', function() {
            logEvent('cm:onModalShow', 'Consent modal shown');
        });
        
        window.addEventListener('cm:onModalHide', function() {
            logEvent('cm:onModalHide', 'Consent modal hidden');
        });
        
        window.addEventListener('cm:onModalReady', function() {
            logEvent('cm:onModalReady', 'Consent modal ready');
            refreshStatus();
        });
        
        // Escape HTML to prevent XSS
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Helper functions
        function logEvent(name, data) {
            const log = document.getElementById('event-log');
            const entry = document.createElement('div');

            const ts = document.createElement('span');
            ts.className = 'timestamp';
            ts.textContent = '[' + new Date().toLocaleTimeString() + ']';

            const nm = document.createElement('span');
            nm.className = 'event-name';
            nm.textContent = name;

            const dt = document.createElement('span');
            dt.className = 'event-data';
            dt.textContent = data;

            entry.appendChild(ts);
            entry.appendChild(document.createTextNode(' '));
            entry.appendChild(nm);
            entry.appendChild(document.createTextNode(' '));
            entry.appendChild(dt);
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('event-log').innerHTML = '<div><span class="timestamp">[Cleared]</span> <span class="event-name">Event log cleared</span></div>';
        }
        
        function refreshStatus() {
            const prefs = ConsentManager.getUserPreferences();
            const cookie = ConsentManager.getCookie();
            const valid = ConsentManager.validConsent();
            
            let statusHTML = '<strong>Accepted Categories:</strong><br>';
            if (prefs && prefs.acceptedCategories) {
                prefs.acceptedCategories.forEach(cat => {
                    statusHTML += `<span class="badge success">${escapeHtml(cat)}</span> `;
                });
                
                if (prefs.rejectedCategories && prefs.rejectedCategories.length > 0) {
                    statusHTML += '<br><strong>Rejected Categories:</strong><br>';
                    prefs.rejectedCategories.forEach(cat => {
                        statusHTML += `<span class="badge danger">${escapeHtml(cat)}</span> `;
                    });
                }
            } else {
                statusHTML += '<span class="badge warning">No consent given yet</span>';
            }
            
            document.getElementById('consent-status').innerHTML = statusHTML;
            document.getElementById('consent-status').className = valid ? 'status-box success' : 'status-box';
            
            document.getElementById('cookie-name').textContent = cookie ? cookie.name : 'cm_cookie';
            document.getElementById('consent-valid').innerHTML = valid ? '<span class="badge success">Yes</span>' : '<span class="badge danger">No</span>';
            document.getElementById('accept-type').textContent = prefs ? (prefs.acceptType || 'custom') : 'none';
            document.getElementById('last-updated').textContent = cookie && cookie.data && cookie.data.lastUpdate ? new Date(cookie.data.lastUpdate).toLocaleString() : 'Never';
        }
        
        function checkTrackingScripts() {
            const analyticsAccepted = ConsentManager.acceptedCategory('analytics');
            const marketingAccepted = ConsentManager.acceptedCategory('marketing');
            
            if (!analyticsAccepted) {
                document.getElementById('analytics-result').innerHTML = 'üö´ Blocked - User did not accept analytics';
                document.getElementById('analytics-status').className = 'tracking-demo blocked';
            }
            
            if (!marketingAccepted) {
                document.getElementById('marketing-result').innerHTML = 'üö´ Blocked - User did not accept marketing';
                document.getElementById('marketing-status').className = 'tracking-demo blocked';
            }
        }
        
        // Control functions
        function showConsentModal() {
            ConsentManager.show();
            logEvent('Action', 'Manually opened consent modal');
        }
        
        function showPreferencesModal() {
            ConsentManager.showPreferences();
            logEvent('Action', 'Manually opened preferences modal');
        }
        
        function hideModals() {
            ConsentManager.hide();
            ConsentManager.hidePreferences();
            logEvent('Action', 'Manually closed all modals');
        }
        
        function acceptAll() {
            ConsentManager.acceptCategory('all');
            logEvent('Action', 'Accepted all categories');
            setTimeout(refreshStatus, 100);
        }
        
        function acceptAnalyticsOnly() {
            ConsentManager.acceptCategory(['necessary', 'analytics']);
            logEvent('Action', 'Accepted necessary + analytics only');
            setTimeout(refreshStatus, 100);
        }
        
        function rejectAll() {
            ConsentManager.acceptCategory([]);
            logEvent('Action', 'Rejected all (necessary only)');
            setTimeout(refreshStatus, 100);
        }
        
        function resetConsent() {
            if (confirm('This will delete your consent cookie and reload the page. Continue?')) {
                ConsentManager.reset(true);
                logEvent('Action', 'Reset consent - reloading page');
                setTimeout(() => location.reload(), 1000);
            }
        }
        
        // ========================================
        // Style Configurator Functions
        // ========================================
        
        let currentConfig = null;
        
        function updateStyle() {
            // Update range value displays
            document.getElementById('font-size-value').textContent = 
                document.getElementById('font-size').value + 'px';
            document.getElementById('border-radius-value').textContent = 
                document.getElementById('border-radius').value + 'px';
            document.getElementById('btn-radius-value').textContent = 
                document.getElementById('btn-radius').value + 'px';
        }
        
        function getConfigFromUI() {
            return {
                guiOptions: {
                    consentModal: {
                        layout: document.getElementById('layout').value,
                        position: document.getElementById('position').value,
                        transition: document.getElementById('transition').value,
                        flipButtons: document.getElementById('flip-buttons').value === 'true'
                    },
                    preferencesModal: {
                        layout: document.getElementById('modal-layout').value,
                        position: document.getElementById('modal-position').value,
                        transition: document.getElementById('transition').value,
                        flipButtons: document.getElementById('flip-buttons').value === 'true'
                    }
                },
                styles: {
                    primaryColor: document.getElementById('primary-color').value,
                    backgroundColor: document.getElementById('bg-color').value,
                    textColor: document.getElementById('text-color').value,
                    buttonTextColor: document.getElementById('btn-text-color').value,
                    fontSize: document.getElementById('font-size').value + 'px',
                    borderRadius: document.getElementById('border-radius').value + 'px',
                    buttonRadius: document.getElementById('btn-radius').value + 'px'
                }
            };
        }
        
        function applyStyle() {
            const config = getConfigFromUI();
            currentConfig = config;
            
            // Apply custom CSS
            applyCustomCSS(config.styles);
            
            // Reinitialize ConsentManager with new guiOptions
            reinitializeConsentManager(config.guiOptions);
            
            logEvent('Style', 'Style configuration applied - ConsentManager reinitialized');
            
            // Show success message
            showCopySuccess('‚ú® Style applied! Opening consent modal...');
            
            // Auto-show the modal to demonstrate changes
            setTimeout(() => {
                ConsentManager.show();
            }, 500);
        }
        
        function applyCustomCSS(styles) {
            // Remove existing custom style if any
            const existingStyle = document.getElementById('custom-consent-style');
            if (existingStyle) {
                existingStyle.remove();
            }
            
            // Create new style element
            const styleEl = document.createElement('style');
            styleEl.id = 'custom-consent-style';
            styleEl.textContent = `
                /* Custom ConsentManager Styles */
                :root {
                    --cm-primary-color: ${styles.primaryColor};
                    --cm-bg-color: ${styles.backgroundColor};
                    --cm-text-color: ${styles.textColor};
                    --cm-btn-text-color: ${styles.buttonTextColor};
                }
                
                #cm-consent-modal,
                #cm-preferences-modal {
                    font-size: ${styles.fontSize} !important;
                }
                
                #cm-consent-modal .cm,
                #cm-preferences-modal .cm {
                    background-color: ${styles.backgroundColor} !important;
                    color: ${styles.textColor} !important;
                    border-radius: ${styles.borderRadius} !important;
                }
                
                #cm-consent-modal .cm-btn,
                #cm-preferences-modal .cm-btn {
                    border-radius: ${styles.buttonRadius} !important;
                }
                
                #cm-consent-modal .cm-btn-primary,
                #cm-preferences-modal .cm-btn-primary,
                #cm-consent-modal .cm-btn.cm-btn-accept,
                #cm-preferences-modal .cm-btn.cm-btn-accept,
                #cm-consent-modal .cm-btn.cm-btn-accept-all,
                #cm-preferences-modal .cm-btn.cm-btn-accept-all {
                    background-color: ${styles.primaryColor} !important;
                    color: ${styles.buttonTextColor} !important;
                    border-color: ${styles.primaryColor} !important;
                }
                
                #cm-consent-modal .cm-btn-primary:hover,
                #cm-preferences-modal .cm-btn-primary:hover,
                #cm-consent-modal .cm-btn.cm-btn-accept:hover,
                #cm-preferences-modal .cm-btn.cm-btn-accept:hover {
                    opacity: 0.9;
                }
                
                #cm-preferences-modal .cm-section-title,
                #cm-preferences-modal .cm-toggle-label {
                    color: ${styles.textColor} !important;
                }
                
                #cm-preferences-modal .cm-toggle-input:checked + .cm-toggle-slider {
                    background-color: ${styles.primaryColor} !important;
                }
                
                #cm-consent-modal h2,
                #cm-preferences-modal h2 {
                    color: ${styles.textColor} !important;
                }
            `;
            
            document.head.appendChild(styleEl);
        }
        
        function showCode() {
            const config = getConfigFromUI();
            const codeOutput = document.getElementById('code-output');
            
            const configCode = `// ConsentManager Configuration
ConsentManager.run({
    // ... your existing configuration ...
    
    // GUI Options
    guiOptions: {
        consentModal: {
            layout: '${config.guiOptions.consentModal.layout}',
            position: '${config.guiOptions.consentModal.position}',
            transition: '${config.guiOptions.consentModal.transition}',
            flipButtons: ${config.guiOptions.consentModal.flipButtons}
        },
        preferencesModal: {
            layout: '${config.guiOptions.preferencesModal.layout}',
            position: '${config.guiOptions.preferencesModal.position}',
            transition: '${config.guiOptions.preferencesModal.transition}',
            flipButtons: ${config.guiOptions.preferencesModal.flipButtons}
        }
    }
});

// Custom CSS Styles (add to your stylesheet)
<style>
:root {
    --cm-primary-color: ${config.styles.primaryColor};
    --cm-bg-color: ${config.styles.backgroundColor};
    --cm-text-color: ${config.styles.textColor};
}

#cm-consent-modal,
#cm-preferences-modal {
    font-size: ${config.styles.fontSize} !important;
}

#cm-consent-modal .cm,
#cm-preferences-modal .cm {
    background-color: ${config.styles.backgroundColor} !important;
    color: ${config.styles.textColor} !important;
    border-radius: ${config.styles.borderRadius} !important;
}

#cm-consent-modal .cm-btn,
#cm-preferences-modal .cm-btn {
    border-radius: ${config.styles.buttonRadius} !important;
}

#cm-consent-modal .cm-btn-primary,
#cm-preferences-modal .cm-btn-primary {
    background-color: ${config.styles.primaryColor} !important;
    color: ${config.styles.buttonTextColor} !important;
}
</style>`;
            
            codeOutput.textContent = configCode;
            codeOutput.classList.add('show');
            
            logEvent('Style', 'Configuration code displayed');
        }
        
        function resetStyle() {
            // Reset all inputs to default values
            document.getElementById('primary-color').value = '#667eea';
            document.getElementById('bg-color').value = '#ffffff';
            document.getElementById('text-color').value = '#2c3e50';
            document.getElementById('btn-text-color').value = '#ffffff';
            document.getElementById('layout').value = 'box';
            document.getElementById('position').value = 'bottom';
            document.getElementById('transition').value = 'slide';
            document.getElementById('modal-layout').value = 'box';
            document.getElementById('modal-position').value = 'center';
            document.getElementById('flip-buttons').value = 'false';
            document.getElementById('font-size').value = '14';
            document.getElementById('border-radius').value = '12';
            document.getElementById('btn-radius').value = '8';
            
            // Update displays
            updateStyle();
            
            // Remove custom CSS
            const existingStyle = document.getElementById('custom-consent-style');
            if (existingStyle) {
                existingStyle.remove();
            }
            
            // Reinitialize with base config (no custom guiOptions)
            ConsentManager.reset();
            ConsentManager.run(JSON.parse(JSON.stringify(baseConfig)));
            
            // Hide code output
            document.getElementById('code-output').classList.remove('show');
            
            logEvent('Style', 'Style reset to defaults - ConsentManager reinitialized');
            showCopySuccess('‚úÖ Style reset to defaults!');
        }
        
        function showCopySuccess(message) {
            const existing = document.querySelector('.copy-success');
            if (existing) {
                existing.remove();
            }
            
            const successEl = document.createElement('div');
            successEl.className = 'copy-success';
            successEl.textContent = message;
            document.body.appendChild(successEl);
            
            setTimeout(() => {
                successEl.style.opacity = '0';
                setTimeout(() => successEl.remove(), 300);
            }, 3000);
        }
        
        // Add copy functionality to code output
        document.addEventListener('click', function(e) {
            if (e.target.closest('#code-output')) {
                const code = document.getElementById('code-output').textContent;
                navigator.clipboard.writeText(code).then(() => {
                    showCopySuccess('‚úÖ Code copied to clipboard!');
                }).catch(() => {
                    showCopySuccess('‚ö†Ô∏è Failed to copy. Please select and copy manually.');
                });
            }
        });
        
        // Initialize style configurator
        updateStyle();
        
        // Initial status check
        setTimeout(refreshStatus, 500);
        setTimeout(checkTrackingScripts, 600);
    </script>
</body>
</html>
