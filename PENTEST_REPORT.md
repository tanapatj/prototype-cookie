# Penetration Testing Report

## ConsentManager - Cookie Consent Management Platform

---

| Field | Detail |
|---|---|
| **Project** | ConsentManager (Cookie Consent + BigQuery Logging) |
| **Client** | Conicle AI |
| **Version Tested** | 1.0.0 |
| **Assessment Date** | February 16, 2026 |
| **Report Classification** | CONFIDENTIAL |
| **Assessment Type** | White-Box Penetration Test (Full Source Code Review) |
| **Scope** | Client-side library, Cloud Functions, Admin/Customer Portals, BigQuery integration, CDN-hosted assets |

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Scope & Methodology](#2-scope--methodology)
3. [Risk Rating Definitions](#3-risk-rating-definitions)
4. [Findings Summary](#4-findings-summary)
5. [Detailed Findings](#5-detailed-findings)
   - [CRITICAL Findings](#critical-findings)
   - [HIGH Findings](#high-findings)
   - [MEDIUM Findings](#medium-findings)
   - [LOW Findings](#low-findings)
   - [INFORMATIONAL Findings](#informational-findings)
6. [Infrastructure & Architecture Review](#6-infrastructure--architecture-review)
7. [GDPR/PDPA Compliance Notes](#7-gdprpdpa-compliance-notes)
8. [Remediation Priority Matrix](#8-remediation-priority-matrix)
9. [Recommendations Summary](#9-recommendations-summary)
10. [Appendix](#10-appendix)

---

## 1. Executive Summary

A comprehensive white-box penetration test was conducted against the ConsentManager platform, which consists of a client-side cookie consent library, two GCP Cloud Functions for logging consent events to BigQuery, an Admin Portal for API key management, a Customer Portal for domain registration, and CDN-hosted static assets on GCP Cloud Storage.

### Overall Risk Rating: **HIGH**

The assessment identified **19 security findings** across the platform:

| Severity | Count |
|---|---|
| **CRITICAL** | 2 |
| **HIGH** | 5 |
| **MEDIUM** | 6 |
| **LOW** | 3 |
| **INFORMATIONAL** | 3 |

**Key Concerns:**
- Hardcoded API keys and Cloud Function URLs exposed in client-side JavaScript
- Multiple Cross-Site Scripting (XSS) vulnerabilities via `innerHTML` injection in all portals
- SQL injection risks in dynamically constructed BigQuery queries in the Admin Portal
- Cryptographically weak random number generation for API key creation
- Open CORS policy on the unauthenticated Cloud Function
- Critical operator-precedence bug in IP hashing that undermines privacy guarantees

The majority of critical and high findings are exploitable with minimal effort and should be remediated before production deployment.

---

## 2. Scope & Methodology

### 2.1 Components Tested

| Component | File(s) | Type |
|---|---|---|
| ConsentManager Library | `src/core/api.js`, `src/utils/cookies.js`, `src/utils/general.js` | Client-side JS |
| Live Demo Page | `demo-live/index.html` | Frontend HTML/JS |
| Test Page | `test-hosted.html` | Frontend HTML/JS |
| Cloud Function (No Auth) | `bigquery/cloud-function/index.js` | Server-side Node.js |
| Cloud Function (Auth) | `bigquery/cloud-function-auth/index.js` | Server-side Node.js |
| Admin Portal | `admin-portal/index.html` | Frontend HTML/JS |
| Customer Portal | `customer-portal/index.html` | Frontend HTML/JS |
| API Key Generator | `bigquery/admin-generate-api-key.js` | CLI Tool (Node.js) |
| BigQuery Schemas | `bigquery/schema.sql`, `bigquery/api-keys-schema.sql` | SQL DDL |
| CDN Assets | GCP Cloud Storage (`consent-manager-cdn-tanapatj-jkt`) | Static hosting |

### 2.2 Methodology

The assessment followed OWASP Testing Guide v4.2 methodology, including:

- **Static Application Security Testing (SAST):** Full source code review of all JavaScript, HTML, and SQL files
- **Architecture Review:** Analysis of data flow between client, CDN, Cloud Functions, and BigQuery
- **Configuration Review:** Analysis of CORS policies, cookie settings, deployment configurations
- **Dependency Analysis:** Review of npm packages and their versions
- **GDPR/PDPA Compliance Review:** Assessment of data handling practices for Thai/EU privacy regulations

### 2.3 Out of Scope

- Live runtime testing against production GCP infrastructure
- DDoS resilience testing
- Physical security of GCP infrastructure
- Third-party component deep analysis (Google Cloud SDK, BigQuery service)

---

## 3. Risk Rating Definitions

| Rating | Description |
|---|---|
| **CRITICAL** | Immediate risk of data breach, system compromise, or significant regulatory violation. Exploitation requires low skill and has high impact. |
| **HIGH** | Significant security weakness that could lead to unauthorized access, data leakage, or system abuse. Exploitation is practical. |
| **MEDIUM** | Security weakness that increases attack surface or could be exploited in combination with other vulnerabilities. |
| **LOW** | Minor security weakness with limited exploitability or impact. Should be addressed as part of security hardening. |
| **INFORMATIONAL** | Best practice deviation or observation that does not represent an immediate risk but should be noted. |

---

## 4. Findings Summary

| ID | Severity | Title | Component |
|---|---|---|---|
| PT-001 | **CRITICAL** | API Key Hardcoded in Client-Side JavaScript | Demo Page | **REMEDIATED** |
| PT-002 | **CRITICAL** | SQL Injection via String Concatenation in Admin Portal | Admin Portal | **REMEDIATED** |
| PT-003 | **HIGH** | Cross-Site Scripting (XSS) via `innerHTML` in Event Logger | Demo Page | **REMEDIATED** |
| PT-004 | **HIGH** | Cross-Site Scripting (XSS) via `innerHTML` in Admin Portal | Admin Portal | **REMEDIATED** |
| PT-005 | **HIGH** | Open CORS Policy (`*`) on Unauthenticated Cloud Function | Cloud Function | **REMEDIATED** |
| PT-006 | **HIGH** | CORS Origin Reflection Before Authentication | Cloud Function (Auth) | **REMEDIATED** |
| PT-007 | **HIGH** | Operator Precedence Bug Breaks IP Hashing | Cloud Function | **REMEDIATED** |
| PT-008 | **MEDIUM** | Cryptographically Weak API Key Generation | Admin Portal |
| PT-009 | **MEDIUM** | API Key Accepted in HTTP Request Body | Cloud Function (Auth) |
| PT-010 | **MEDIUM** | Hardcoded IP Hash Salt with Weak Fallback | Cloud Functions |
| PT-011 | **MEDIUM** | ReDoS Risk in Domain Whitelist Validation | Cloud Function (Auth) |
| PT-012 | **MEDIUM** | Cloud Function Deployed with `--allow-unauthenticated` | Infrastructure |
| PT-013 | **MEDIUM** | Potential Script Injection via `loadScript` Selector | ConsentManager Lib |
| PT-014 | **LOW** | Missing Security Headers on All HTML Pages | All Frontends |
| PT-015 | **LOW** | Cloud Function URL and Project ID Exposed in Source | All Frontends |
| PT-016 | **LOW** | No Rate Limiting on Unauthenticated Cloud Function | Cloud Function |
| PT-017 | **INFO** | Customer Portal Registration Has No Backend | Customer Portal |
| PT-018 | **INFO** | Debug Logging Enabled in Production Library | ConsentManager Lib |
| PT-019 | **INFO** | Raw IP Address Logging Enabled by Default | Cloud Functions |

---

## 5. Detailed Findings

---

### CRITICAL Findings

---

#### PT-001: API Key Hardcoded in Client-Side JavaScript

| Field | Detail |
|---|---|
| **Severity** | CRITICAL |
| **CVSS 3.1** | 9.1 (Critical) |
| **CWE** | CWE-798: Use of Hard-coded Credentials |
| **Component** | `demo-live/index.html` (line 480) |
| **Status** | Open |

**Description:**

The BigQuery logging API key is hardcoded directly in client-side JavaScript, making it trivially accessible to any visitor of the page:

```javascript
const BIGQUERY_API_KEY = 'demo-key-12345678-1234-1234-1234-123456789abc';
```

**Impact:**

- Any user can extract the API key by viewing the page source or browser developer tools
- Attackers can use the key to send arbitrary data to BigQuery, polluting consent analytics
- The API key can be used to exhaust the monthly quota, causing denial of service for legitimate logging
- If the same key pattern is used across clients, it could compromise other tenants

**Proof of Concept:**

```bash
# Extracted directly from page source, anyone can call:
curl -X POST https://logconsentauth-pxoxh5sfqa-as.a.run.app \
  -H "Content-Type: application/json" \
  -H "X-API-Key: demo-key-12345678-1234-1234-1234-123456789abc" \
  -d '{"event_type":"fake","cookie":{"categories":["injected"]}}'
```

**Remediation:**

1. **Never embed API keys in client-side code.** Use a server-side proxy that authenticates users and appends the API key server-side.
2. Implement additional authentication mechanisms (e.g., signed requests with short-lived tokens).
3. If client-side keys are unavoidable, implement strict rate limiting, IP-based throttling, and anomaly detection.
4. Rotate the exposed demo key immediately.

---

#### PT-002: SQL Injection via String Concatenation in Admin Portal

| Field | Detail |
|---|---|
| **Severity** | CRITICAL |
| **CVSS 3.1** | 8.6 (High) |
| **CWE** | CWE-89: SQL Injection |
| **Component** | `admin-portal/index.html` (lines 548-573) |
| **Status** | Open |

**Description:**

The Admin Portal constructs BigQuery SQL statements using direct string concatenation with user-supplied input, without any sanitization or parameterized queries:

```javascript
const sqlCommand = `-- Run this command in BigQuery console or gcloud:
bq query --use_legacy_sql=false "
INSERT INTO \`${PROJECT_ID}.${DATASET_ID}.api_keys\`
  (api_key, ..., client_name, client_email, ..., notes)
VALUES
  (
    '${apiKey}',
    ...
    '${clientName}',
    ${emailSQL},
    ...
    ${notesSQL}
  )
"`;
```

Values like `clientName`, `emailSQL`, and `notesSQL` are derived directly from form inputs without escaping.

**Impact:**

- An admin entering a malicious value in the "Client Name" field (e.g., `'); DROP TABLE api_keys; --`) could execute arbitrary SQL in BigQuery
- Could lead to data destruction, unauthorized data access, or privilege escalation
- Even though the SQL is displayed for manual execution, if this flow is ever automated, it becomes directly exploitable

**Proof of Concept:**

Enter the following as a "Client Name" in the Admin Portal:
```
Acme'); DELETE FROM `conicle-ai-dev.consent_analytics.api_keys` WHERE TRUE; --
```

The resulting SQL command would terminate the INSERT and execute a DELETE statement.

**Remediation:**

1. Use BigQuery parameterized queries exclusively (as done correctly in `cloud-function-auth/index.js`)
2. Implement strict input validation and sanitization for all form fields
3. Apply allowlist-based character filtering for client names (alphanumeric, spaces, hyphens only)
4. Escape all single quotes in string values before SQL construction

---

### HIGH Findings

---

#### PT-003: Cross-Site Scripting (XSS) via `innerHTML` in Event Logger

| Field | Detail |
|---|---|
| **Severity** | HIGH |
| **CVSS 3.1** | 7.1 (High) |
| **CWE** | CWE-79: Cross-Site Scripting (Reflected) |
| **Component** | `demo-live/index.html` (lines 666-672) |
| **Status** | Open |

**Description:**

The `logEvent` function injects unsanitized data into the DOM using `innerHTML`:

```javascript
function logEvent(name, data) {
    const log = document.getElementById('event-log');
    const timestamp = new Date().toLocaleTimeString();
    const entry = document.createElement('div');
    entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> <span class="event-name">${name}</span> <span class="event-data">${data}</span>`;
    log.appendChild(entry);
}
```

The `name` and `data` parameters are derived from consent event data (including cookie category names), which could be attacker-controlled if the consent configuration is modified or intercepted.

**Impact:**

- Arbitrary JavaScript execution in the context of the demo page
- Cookie theft, session hijacking, or redirection to malicious sites
- Possible phishing via injected UI elements

**Remediation:**

1. Replace `innerHTML` with `textContent` for data values, or use DOM creation methods:
```javascript
const nameSpan = document.createElement('span');
nameSpan.className = 'event-name';
nameSpan.textContent = name;
```
2. Implement a sanitization function that escapes HTML entities for any values rendered via `innerHTML`.

---

#### PT-004: Cross-Site Scripting (XSS) via `innerHTML` in Admin Portal

| Field | Detail |
|---|---|
| **Severity** | HIGH |
| **CVSS 3.1** | 7.1 (High) |
| **CWE** | CWE-79: Cross-Site Scripting (Stored/DOM-based) |
| **Component** | `admin-portal/index.html` (lines 488-493, 575-583) |
| **Status** | Open |

**Description:**

The `showAlert` function and the API key generation result display inject user-provided values directly into `innerHTML`:

```javascript
function showAlert(message, type = 'success') {
    const container = document.getElementById('alert-container');
    const alertClass = type === 'error' ? 'alert-error' : 'alert-success';
    container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
}
```

The message parameter includes unsanitized user form input (client name, email, domains, notes) directly:

```javascript
showAlert(`<strong>✅ API Key Generated!</strong><br><br>
    ...${sqlCommand.replace(/\n/g, '<br>')}...
`);
```

The same vulnerability exists in `customer-portal/index.html` (lines 333-337, 385-395).

**Impact:**

- If form fields contain HTML/JavaScript, it will execute in the admin's browser
- Self-XSS that could be escalated via social engineering
- In a multi-admin scenario, one admin could inject malicious scripts for others

**Remediation:**

1. Sanitize all user input before inserting into `innerHTML`
2. Use a safe HTML encoding function:
```javascript
function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}
```
3. Use `textContent` where HTML formatting is not needed

---

#### PT-005: Open CORS Policy on Unauthenticated Cloud Function

| Field | Detail |
|---|---|
| **Severity** | HIGH |
| **CVSS 3.1** | 7.5 (High) |
| **CWE** | CWE-942: Overly Permissive Cross-domain Whitelist |
| **Component** | `bigquery/cloud-function/index.js` (line 118) |
| **Status** | Open |

**Description:**

The unauthenticated Cloud Function sets a wildcard CORS origin:

```javascript
res.set('Access-Control-Allow-Origin', '*');
```

Combined with the absence of any authentication (no API key required), any website on the internet can send consent events to BigQuery.

**Impact:**

- Any website can call the logging endpoint without authentication
- Attackers can flood BigQuery with fake consent events (data pollution)
- Potential cost escalation via high-volume requests to BigQuery
- No attribution or accountability for logged events

**Remediation:**

1. Remove the unauthenticated Cloud Function from production deployment
2. Use only the authenticated version (`cloud-function-auth`) with proper domain validation
3. Restrict CORS origins to specific, known domains
4. Implement rate limiting at the Cloud Function or API Gateway level

---

#### PT-006: CORS Origin Reflection Before Authentication

| Field | Detail |
|---|---|
| **Severity** | HIGH |
| **CVSS 3.1** | 6.5 (Medium) |
| **CWE** | CWE-942: Overly Permissive Cross-domain Whitelist |
| **Component** | `bigquery/cloud-function-auth/index.js` (lines 215-218) |
| **Status** | Open |

**Description:**

The authenticated Cloud Function reflects the request origin in the CORS response header *before* performing API key or domain validation:

```javascript
const origin = req.headers.origin || req.headers.referer;
res.set('Access-Control-Allow-Origin', origin || '*');
res.set('Access-Control-Allow-Methods', 'POST, OPTIONS');
res.set('Access-Control-Allow-Headers', 'Content-Type, X-API-Key');
```

If no origin is provided, it falls back to `*`. The CORS header is set regardless of whether the request later fails authentication.

**Impact:**

- Browsers will accept the response from any origin, even if the request is unauthenticated
- Error responses (401, 400) will still include the permissive CORS header, potentially leaking error details cross-origin
- The preflight (OPTIONS) handler returns CORS headers without any validation

**Remediation:**

1. Validate the origin against the allowed domains list *before* setting CORS headers:
```javascript
const allowedOrigins = ['https://app.conicle.ai', 'https://demo.conicle.ai'];
const origin = req.headers.origin;
if (allowedOrigins.includes(origin)) {
    res.set('Access-Control-Allow-Origin', origin);
}
```
2. Never fall back to `*` in production
3. Move CORS header setting to after authentication succeeds

---

#### PT-007: Operator Precedence Bug Breaks IP Hashing

| Field | Detail |
|---|---|
| **Severity** | HIGH |
| **CVSS 3.1** | 7.4 (High) |
| **CWE** | CWE-783: Operator Precedence Logic Error |
| **Component** | `bigquery/cloud-function/index.js` (line 23) |
| **Status** | Open |

**Description:**

The IP hashing function in the unauthenticated Cloud Function has an operator precedence bug:

```javascript
function hashIP(ip) {
  if (!ip) return null;
  return crypto.createHash('sha256').update(ip + process.env.IP_SALT || 'conicle-salt').digest('hex');
}
```

Due to JavaScript operator precedence, `+` is evaluated before `||`. If `process.env.IP_SALT` is undefined:
- `ip + undefined` evaluates to the string `"192.168.1.1undefined"`
- `"192.168.1.1undefined" || 'conicle-salt'` evaluates to `"192.168.1.1undefined"` (a truthy string)
- The fallback salt `'conicle-salt'` is **never used**

This means different IPs produce predictable hashes without a salt, making it trivial to reverse them via rainbow tables.

Note: The authenticated version (`cloud-function-auth/index.js` line 123) correctly uses parentheses: `(process.env.IP_SALT || 'conicle-salt')`.

**Impact:**

- IP hashes are computed without a proper salt, undermining GDPR privacy guarantees
- Rainbow table attacks can reverse IP hashes to recover raw IP addresses
- Potential GDPR/PDPA violation if IP hashes are relied upon as the anonymization mechanism

**Remediation:**

1. Add parentheses to enforce correct evaluation order:
```javascript
return crypto.createHash('sha256').update(ip + (process.env.IP_SALT || 'conicle-salt')).digest('hex');
```
2. Always set the `IP_SALT` environment variable in production (never rely on fallback)
3. Use a cryptographically random salt of at least 32 bytes
4. Re-hash all existing IP hashes after fixing the bug

---

### MEDIUM Findings

---

#### PT-008: Cryptographically Weak API Key Generation

| Field | Detail |
|---|---|
| **Severity** | MEDIUM |
| **CVSS 3.1** | 5.9 (Medium) |
| **CWE** | CWE-338: Use of Cryptographically Weak PRNG |
| **Component** | `admin-portal/index.html` (lines 479-485) |
| **Status** | Open |

**Description:**

The Admin Portal generates API keys using `Math.random()`, which is not cryptographically secure:

```javascript
function generateUUID() {
    return 'cm_' + 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}
```

The same issue exists in `admin-generate-api-key.js` (lines 37-43).

**Impact:**

- `Math.random()` values can be predicted if the internal state is known
- Attackers who observe multiple generated keys may be able to predict future keys
- Reduces the effective entropy of API keys significantly

**Remediation:**

1. Use `crypto.getRandomValues()` in the browser:
```javascript
function generateUUID() {
    return 'cm_' + ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
}
```
2. In Node.js (admin-generate-api-key.js), use `crypto.randomUUID()` or `uuid` library

---

#### PT-009: API Key Accepted in HTTP Request Body

| Field | Detail |
|---|---|
| **Severity** | MEDIUM |
| **CVSS 3.1** | 5.3 (Medium) |
| **CWE** | CWE-598: Use of GET Request Method With Sensitive Query Strings |
| **Component** | `bigquery/cloud-function-auth/index.js` (line 234) |
| **Status** | Open |

**Description:**

The Cloud Function accepts API keys from either the header or the request body:

```javascript
const apiKey = req.headers['x-api-key'] || req.body.apiKey;
```

**Impact:**

- API keys in request bodies are more likely to be logged in application logs, load balancer access logs, and monitoring tools
- Body-based keys may be cached by intermediary proxies
- Inconsistent authentication method increases the attack surface

**Remediation:**

1. Accept API keys only via the `X-API-Key` header
2. Remove `req.body.apiKey` fallback
3. Document that all clients must use the header-based approach

---

#### PT-010: Hardcoded IP Hash Salt with Weak Fallback

| Field | Detail |
|---|---|
| **Severity** | MEDIUM |
| **CVSS 3.1** | 5.3 (Medium) |
| **CWE** | CWE-798: Use of Hard-coded Credentials |
| **Component** | Both Cloud Functions |
| **Status** | Open |

**Description:**

Both Cloud Functions use a hardcoded fallback salt for IP hashing:

```javascript
// cloud-function-auth/index.js (line 123)
return crypto.createHash('sha256').update(ip + (process.env.IP_SALT || 'conicle-salt')).digest('hex');
```

The salt `'conicle-salt'` is visible in the source code and provides minimal entropy.

**Impact:**

- If the environment variable is not set, all deployments use the same predictable salt
- Known salt combined with a limited IP address space makes brute-force reversal feasible
- Compromises the GDPR/PDPA anonymization guarantee of IP hashing

**Remediation:**

1. Generate a unique, cryptographically random salt per deployment (minimum 32 bytes)
2. Store the salt in GCP Secret Manager, not in environment variables
3. Remove the hardcoded fallback; fail closed if the salt is unavailable
4. Consider using HMAC-SHA256 instead of SHA256 with concatenation

---

#### PT-011: ReDoS Risk in Domain Whitelist Validation

| Field | Detail |
|---|---|
| **Severity** | MEDIUM |
| **CVSS 3.1** | 5.3 (Medium) |
| **CWE** | CWE-1333: Inefficient Regular Expression Complexity |
| **Component** | `bigquery/cloud-function-auth/index.js` (lines 67-70) |
| **Status** | Open |

**Description:**

Domain whitelist patterns are converted to regular expressions using simple string replacement:

```javascript
const regex = new RegExp('^' + pattern.replace(/\*/g, '.*').replace(/\./g, '\\.') + '$');
return regex.test(domain);
```

If an admin creates a malicious or complex domain pattern (e.g., `*.*.*.*.*.*.*.*`), it translates to `^.*\\..*\\..*\\..*\\..*\\..*\\..*\\..*$`, which could cause catastrophic backtracking.

**Impact:**

- Denial of service via slow regex evaluation
- Cloud Function timeout leading to failed consent logging
- Increased GCP billing from extended function execution time

**Remediation:**

1. Use simple string matching (prefix/suffix) instead of regex for domain validation
2. Limit the number and complexity of wildcard patterns
3. Validate domain patterns at insertion time (Admin Portal)
4. Set a timeout for regex evaluation

---

#### PT-012: Cloud Function Deployed with `--allow-unauthenticated`

| Field | Detail |
|---|---|
| **Severity** | MEDIUM |
| **CVSS 3.1** | 5.3 (Medium) |
| **CWE** | CWE-306: Missing Authentication for Critical Function |
| **Component** | `bigquery/cloud-function-auth/package.json` (line 14) |
| **Status** | Open |

**Description:**

The deployment script uses `--allow-unauthenticated`:

```json
"deploy": "gcloud functions deploy logConsentAuth --runtime nodejs20 --trigger-http --allow-unauthenticated --region asia-southeast1 --project conicle-ai-dev"
```

This means the Cloud Function is publicly accessible without GCP IAM authentication, relying solely on the application-level API key for security.

**Impact:**

- Anyone can reach the Cloud Function endpoint (defense-in-depth principle violated)
- No GCP-level protection against abuse or scanning
- The API key is the sole authentication layer

**Remediation:**

1. Use GCP API Gateway or Cloud Endpoints in front of the Cloud Function
2. Consider implementing GCP Identity-Aware Proxy (IAP)
3. If `--allow-unauthenticated` is required for CORS preflight, add GCP Cloud Armor rules for rate limiting

---

#### PT-013: Potential Script Injection via `loadScript` Selector

| Field | Detail |
|---|---|
| **Severity** | MEDIUM |
| **CVSS 3.1** | 4.7 (Medium) |
| **CWE** | CWE-79: Cross-Site Scripting |
| **Component** | `src/core/api.js` (line 443) |
| **Status** | Open |

**Description:**

The `loadScript` function uses string concatenation to build a CSS selector:

```javascript
let script = document.querySelector('script[src="' + src + '"]');
```

If the `src` parameter contains specially crafted characters (e.g., `"]`), it could break out of the selector context.

**Impact:**

- Could potentially be used to bypass the duplicate-script check
- May allow loading malicious scripts if the `src` parameter is user-controlled

**Remediation:**

1. Use `CSS.escape()` to sanitize the `src` value:
```javascript
let script = document.querySelector(`script[src="${CSS.escape(src)}"]`);
```
2. Alternatively, iterate over script elements and compare `src` properties directly

---

### LOW Findings

---

#### PT-014: Missing Security Headers on All HTML Pages

| Field | Detail |
|---|---|
| **Severity** | LOW |
| **CVSS 3.1** | 3.7 (Low) |
| **CWE** | CWE-693: Protection Mechanism Failure |
| **Component** | All HTML pages |
| **Status** | Open |

**Description:**

None of the HTML pages include security-related HTTP headers or meta tags:

- No `Content-Security-Policy` (CSP) header
- No `X-Frame-Options` header (vulnerable to clickjacking)
- No `X-Content-Type-Options: nosniff`
- No `Referrer-Policy` header
- No `Permissions-Policy` header

**Remediation:**

1. Add a Content Security Policy via meta tag or HTTP header:
```html
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://storage.googleapis.com; style-src 'self' 'unsafe-inline'">
```
2. Add `X-Frame-Options: DENY` to prevent clickjacking
3. Configure these headers at the GCP Cloud Storage or CDN level

---

#### PT-015: Cloud Function URL and Project ID Exposed in Source

| Field | Detail |
|---|---|
| **Severity** | LOW |
| **CVSS 3.1** | 3.7 (Low) |
| **CWE** | CWE-200: Exposure of Sensitive Information |
| **Component** | `demo-live/index.html`, `admin-portal/index.html`, `customer-portal/index.html` |
| **Status** | Open |

**Description:**

Multiple sensitive infrastructure identifiers are exposed in client-side code:

- Cloud Function URL: `https://logconsentauth-pxoxh5sfqa-as.a.run.app`
- GCP Project ID: `conicle-ai-dev`
- BigQuery Dataset: `consent_analytics`
- BigQuery Table names: `consent_events`, `api_keys`
- CDN Bucket: `consent-manager-cdn-tanapatj-jkt`

**Impact:**

- Aids reconnaissance for targeted attacks against the GCP project
- Bucket name exposure could lead to enumeration attacks
- Knowledge of internal table structure aids SQL injection attacks

**Remediation:**

1. Use environment-specific configuration files rather than hardcoding
2. Proxy API calls through a backend that hides infrastructure details
3. Minimize exposed information in client-side code

---

#### PT-016: No Rate Limiting on Unauthenticated Cloud Function

| Field | Detail |
|---|---|
| **Severity** | LOW |
| **CVSS 3.1** | 3.7 (Low) |
| **CWE** | CWE-770: Allocation of Resources Without Limits |
| **Component** | `bigquery/cloud-function/index.js` |
| **Status** | Open |

**Description:**

The unauthenticated Cloud Function has no rate limiting, no request throttling, and no abuse prevention mechanisms. While the authenticated version has a monthly quota system, the unauthenticated version is entirely open.

**Remediation:**

1. Deprecate and remove the unauthenticated Cloud Function
2. If needed, implement per-IP rate limiting using GCP Cloud Armor or a middleware
3. Add request size limits to prevent large payloads

---

### INFORMATIONAL Findings

---

#### PT-017: Customer Portal Registration Has No Backend

| Field | Detail |
|---|---|
| **Severity** | INFORMATIONAL |
| **Component** | `customer-portal/index.html` |
| **Status** | Noted |

**Description:**

The Customer Portal registration form does not submit data to any backend. Instead, it simulates a successful submission using `setTimeout` and logs the form data to the browser console:

```javascript
setTimeout(() => {
    // Hide form, show success
    console.log('=== NEW REGISTRATION REQUEST ===');
    console.log(JSON.stringify(formData, null, 2));
}, 1500);
```

**Impact:**

- Customers may believe their registration was processed when it was not
- No actual data persistence or notification system

**Recommendation:**

Implement a backend API to receive and store registration requests, or clearly label the portal as a demo/prototype.

---

#### PT-018: Debug Logging Enabled in Production Library

| Field | Detail |
|---|---|
| **Severity** | INFORMATIONAL |
| **Component** | `src/utils/general.js` (lines 12-14) |
| **Status** | Noted |

**Description:**

The `debug` function directly calls `console.log`, which means all debug output is visible in production:

```javascript
export const debug = (...params) => {
    console.log(...params);
};
```

**Recommendation:**

Make debug logging conditional based on a configuration flag or environment variable.

---

#### PT-019: Raw IP Address Logging Enabled by Default

| Field | Detail |
|---|---|
| **Severity** | INFORMATIONAL |
| **Component** | Both Cloud Functions, `demo-live/index.html` |
| **Status** | Noted |

**Description:**

The demo page explicitly enables raw IP address logging:

```javascript
logIP: true  // NOW ENABLED: Raw IP address will be logged
```

And the Cloud Function stores raw IPs when `logIP` is not explicitly `false`:

```javascript
ip_address: data.logIP !== false ? clientIP : null,
```

**Impact:**

- Under GDPR and Thailand's PDPA, IP addresses are considered personal data
- Storing raw IP addresses requires explicit legal basis and proper disclosure to data subjects
- The cookie consent banner does not explicitly mention IP address collection

**Recommendation:**

1. Default to `logIP: false` and only store hashed IPs
2. If raw IPs are needed, clearly disclose this in the consent banner
3. Implement data retention policies with automatic deletion

---

## 6. Infrastructure & Architecture Review

### 6.1 Architecture Diagram

```
User Browser
    |
    |-- [HTTPS] --> GCP Cloud Storage CDN (consent-manager.js, consent-manager.css)
    |                   Region: asia-southeast3 (Bangkok)
    |
    |-- [HTTPS] --> Cloud Function (logConsentAuth)
    |                   Region: asia-southeast1 (Singapore)
    |                   Runtime: Node.js 20
    |                   Auth: API Key (X-API-Key header)
    |                   |
    |                   |--> BigQuery (consent_analytics.consent_events)
    |                   |--> BigQuery (consent_analytics.api_keys)
    |
    |-- [HTTPS] --> Cloud Function (logConsent) [DEPRECATED - NO AUTH]
                        Region: asia-southeast3 (Bangkok)
```

### 6.2 Architecture Observations

| Area | Observation | Risk |
|---|---|---|
| **CDN** | Static assets on GCS with public-read | Low - standard for CDN |
| **Cloud Functions** | Two versions exist (auth & no-auth) | High - unauthenticated version should be removed |
| **BigQuery** | API keys stored in same dataset as events | Medium - separation of concerns |
| **Regions** | CDN in Bangkok, Function in Singapore | Low - latency consideration |
| **TLS** | All endpoints use HTTPS | Good |
| **Dependencies** | `@google-cloud/bigquery@^7.3.0`, `uuid@^9.0.1` | Low - current versions |

---

## 7. GDPR/PDPA Compliance Notes

| Requirement | Status | Notes |
|---|---|---|
| **Consent before tracking** | PASS | Scripts with `type="text/plain"` are blocked until consent |
| **Granular consent** | PASS | Users can accept/reject individual categories |
| **Right to withdraw** | PASS | Reset function clears consent cookie |
| **Data minimization** | PARTIAL | Raw IP addresses are logged by default (PT-019) |
| **Privacy by design** | PARTIAL | IP hashing bug undermines anonymization (PT-007) |
| **Lawful basis for IP logging** | NEEDS REVIEW | Consent banner doesn't mention IP collection |
| **Data retention** | NOT IMPLEMENTED | No automatic deletion of old consent events |
| **Cross-border data transfer** | NEEDS REVIEW | Data flows from Bangkok CDN to Singapore Function to US BigQuery |
| **Cookie disclosure** | PASS | Cookie table provided in preferences modal |
| **Consent proof** | PASS | ConsentId and timestamps stored in BigQuery |

---

## 8. Remediation Priority Matrix

### Immediate (Before Production - Week 1)

| ID | Finding | Effort | Impact |
|---|---|---|---|
| PT-001 | Remove hardcoded API key from client-side code | Medium | Eliminates credential exposure |
| PT-002 | Fix SQL injection in Admin Portal | Low | Prevents data destruction |
| PT-003/004 | Fix all `innerHTML` XSS vulnerabilities | Low | Prevents script injection |
| PT-007 | Fix operator precedence bug in IP hashing | Low | Restores privacy guarantees |

### Short-Term (Week 2-3)

| ID | Finding | Effort | Impact |
|---|---|---|---|
| PT-005 | Remove unauthenticated Cloud Function | Low | Eliminates open endpoint |
| PT-006 | Fix CORS origin reflection | Low | Proper cross-origin security |
| PT-008 | Use crypto-secure random for API keys | Low | Stronger key generation |
| PT-010 | Move IP salt to Secret Manager | Medium | Proper secret management |
| PT-012 | Add GCP API Gateway or Cloud Armor | Medium | Defense in depth |

### Medium-Term (Month 1-2)

| ID | Finding | Effort | Impact |
|---|---|---|---|
| PT-009 | Remove body-based API key acceptance | Low | Reduce key exposure surface |
| PT-011 | Replace regex domain matching | Medium | Prevent ReDoS |
| PT-013 | Fix `loadScript` selector injection | Low | Harden client library |
| PT-014 | Add security headers | Low | General hardening |
| PT-016 | Implement rate limiting | Medium | Abuse prevention |

### Ongoing

| ID | Finding | Effort | Impact |
|---|---|---|---|
| PT-015 | Minimize infrastructure exposure | Medium | Reduce recon surface |
| PT-017 | Implement customer portal backend | High | Real registration flow |
| PT-018 | Conditional debug logging | Low | Reduce information leakage |
| PT-019 | Default to hashed-only IP logging | Low | GDPR/PDPA compliance |

---

## 9. Recommendations Summary

### Architecture & Design
1. **Implement a server-side proxy** for BigQuery logging to eliminate client-side API key exposure
2. **Deprecate the unauthenticated Cloud Function** immediately
3. **Add GCP API Gateway** in front of Cloud Functions for centralized auth, rate limiting, and monitoring
4. **Separate BigQuery datasets** for API keys and consent events (principle of least privilege)

### Code Security
5. **Eliminate all `innerHTML` usage** with user-controlled data; use `textContent` or DOM APIs
6. **Use parameterized queries** exclusively for all SQL operations
7. **Use `crypto.getRandomValues()` / `crypto.randomUUID()`** for all security-sensitive random values
8. **Implement input validation** on all form fields and API parameters

### Infrastructure
9. **Store secrets in GCP Secret Manager** (IP salt, API keys)
10. **Add Cloud Armor WAF rules** for DDoS protection and rate limiting
11. **Enable GCP Cloud Audit Logs** for all BigQuery operations
12. **Implement automated alerting** for unusual API usage patterns

### Compliance
13. **Update privacy notice** in the consent banner to disclose IP address collection
14. **Implement data retention policies** with automatic deletion (e.g., 90-day rolling window)
15. **Document data flow** for GDPR Article 30 Records of Processing Activities
16. **Conduct Data Protection Impact Assessment (DPIA)** before production launch

---

## 10. Appendix

### A. Tools Used

| Tool | Purpose |
|---|---|
| Manual Code Review | Primary analysis method (white-box) |
| OWASP Testing Guide v4.2 | Methodology framework |
| CWE/CVSS v3.1 | Vulnerability classification and scoring |
| Node.js dependency analysis | Package version review |

### B. Files Reviewed

| File | Lines | Type |
|---|---|---|
| `demo-live/index.html` | 773 | Frontend |
| `admin-portal/index.html` | 701 | Frontend |
| `customer-portal/index.html` | 483 | Frontend |
| `test-hosted.html` | 186 | Frontend |
| `bigquery/cloud-function-auth/index.js` | 362 | Backend |
| `bigquery/cloud-function/index.js` | 243 | Backend |
| `bigquery/admin-generate-api-key.js` | 138 | CLI Tool |
| `src/core/api.js` | 741 | Library |
| `src/utils/cookies.js` | 407 | Library |
| `src/utils/general.js` | 960 | Library |
| `bigquery/schema.sql` | 76 | Schema |
| `bigquery/api-keys-schema.sql` | 57 | Schema |
| `package.json` (root) | 65 | Config |
| `bigquery/cloud-function-auth/package.json` | 16 | Config |

### C. CVSS Scoring Reference

All CVSS scores calculated using CVSS v3.1 calculator (https://www.first.org/cvss/calculator/3.1).

### D. Glossary

| Term | Definition |
|---|---|
| **XSS** | Cross-Site Scripting - injection of malicious scripts into web pages |
| **CORS** | Cross-Origin Resource Sharing - browser mechanism for controlled cross-domain access |
| **CSRF** | Cross-Site Request Forgery - forcing authenticated users to perform unwanted actions |
| **ReDoS** | Regular Expression Denial of Service - exploiting regex backtracking |
| **PRNG** | Pseudo-Random Number Generator |
| **PDPA** | Thailand's Personal Data Protection Act (พ.ร.บ. คุ้มครองข้อมูลส่วนบุคคล) |
| **GDPR** | EU General Data Protection Regulation |
| **WAF** | Web Application Firewall |

---

**End of Report**

*This report is confidential and intended only for the authorized recipients. Distribution of this report outside of the Conicle AI security team requires written approval.*
